# ============================================================================
# FAIRINO FR5 + RealSense D435i 视觉伺服配置文件
# ============================================================================

# ---------- 机器人连接 ----------
robot:
  ip: "192.168.1.200"
  cmdT: 0.008  # 伺服周期 8ms (125Hz)

# ---------- 相机与Tag ----------
camera:
  fps: 30
  width: 1280  # 720p分辨率
  height: 720

aruco:
  dictionary: "DICT_4X4_50"  # 支持: DICT_4X4_50, DICT_6X6_250, DICT_ARUCO_ORIGINAL 等
  tag_size: 0.05  # Tag边长（米），根据实际打印尺寸修改
  target_id: 0   # -1=自动选择（最大面积），>=0=跟随指定ID

# ---------- 控制目标 ----------
target:
  z_des: 0.50  # 期望距离（米）：相机到Tag的距离
  enable_yaw: true     # 启用yaw控制（Rz）✓
  enable_pitch: true   # 启用pitch控制（Ry）✓
  enable_roll: false   # 禁用roll（Rx存在物理耦合，无法稳定收敛）

# ---------- 控制律增益（外环）----------
controller:
  # 像素误差->速度（相机系）- 独立控制每个轴
  # 6自由度联合控制（新标定后已全部验证）
  use_handeye_transform: true  # 启用手眼变换（使用修正后的坐标系）
  k_x: -2.5      # X轴增益：平衡速度与稳定性
  k_y: -2.5      # Y轴增益：平衡速度与稳定性
  k_z: -2.0      # Z轴增益：平衡速度与稳定性
  
  # 自适应增益（远距离快速收敛，近距离平稳精确）
  enable_adaptive_gain: true    # 启用自适应增益
  k_x_far: -6.0     # 远距离X轴增益（误差>阈值时）
  k_y_far: -6.0     # 远距离Y轴增益（误差>阈值时）
  adaptive_threshold_px: 30.0   # 自适应切换阈值（像素），超过此值使用远距离增益
  k_yaw: 0.5     # yaw增益：正值（已验证）✓
  k_pitch: -0.5  # pitch增益：负值（已验证）✓
  k_roll: -0.2   # roll增益：降低到-0.2，更平稳的收敛
  
  # 限幅（每8ms增量，工具坐标系）
  max_trans_mm_per_tick: 0.8   # 平移最大增量：100mm/s，快速且稳定
  max_rot_deg_per_tick: 0.15   # 旋转最大增量：适当提高到0.15
  
  # 死区（避免到位抖动）- 大死区是关键！
  deadband_px: 5.0   # 像素误差死区：提高到5.0防止震荡
  deadband_mm: 5.0   # 距离误差死区：提高到5.0防止震荡
  deadband_deg: 5.0  # 旋转误差死区（yaw/pitch）
  deadband_roll_deg: 5.0  # roll死区：降低到5°，允许收敛，但仍能防止到位震荡
  
  # 过时数据处理
  stale_timeout_ms: 50   # 超过此时间未更新视觉数据，认为过时
  decay_tau_s: 0.10      # 指数衰减时间常数（秒）
  
  # 延迟预测（可选，实验性）
  enable_prediction: false
  prediction_horizon_ms: 20
  
  # 低通滤波（必须开启）- 平滑快速控制
  enable_lpf: true
  lpf_alpha: 0.5  # 增强滤波到0.5，减少震荡

# ---------- 眼在手手眼标定外参 ----------
# T_flange_cam: 法兰坐标系到相机坐标系的变换（4x4齐次矩阵）
# 标定日期：2026-01-23（坐标系修正后），使用 handeye_calibration_eye_in_hand.py --use-flange
# 关键修正：Z平移现为正值（+49.97mm），符合相机在法兰下方的物理事实 ✓
handeye:
  T_tool_cam:
    # 旋转矩阵（3x3）+ 平移向量（3x1，单位米）
    R:  # 旋转矩阵（行优先）
      - [0.99827958, 0.01690417, -0.05614389]
      - [-0.01182179, 0.99590292, 0.08965275]
      - [0.05742937, -0.08883479, 0.99438938]
    t:  # 平移向量（米）
      - -0.02020931
      - -0.06249392
      - 0.04996680

# ---------- 手眼标定数据采集 ----------
calib_collect:
  save_dir: "calib_data"
  num_poses: 15  # 建议采集姿态数量
  wait_stable_s: 1.0  # 每次移动后等待稳定时间

# ---------- 日志与调试 ----------
debug:
  enable_viz: true   # 实时显示图像与检测结果
  print_freq_hz: 2.0  # 打印频率（Hz）
  save_log: true     # 保存控制日志
  log_dir: "servo_logs"
  verbose_log: false  # 详细日志模式（显示所有ROLL_DEBUG等调试信息，设为false则只显示INFO/WARNING/ERROR）
